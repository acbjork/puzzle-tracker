<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üß† I'm Puzzled ‚ÄºÔ∏è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      height: 100vh; 
      overflow: hidden;
      background: #f8f9fa;
    }

    /* Claude-style Layout: Top strip, scrollable middle, bottom strip */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Top Strip - Scoreboard/History */
    .top-strip {
      background: linear-gradient(135deg, #6b46c1, #8b5cf6);
      color: white;
      padding: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
      z-index: 100;
    }

    .top-strip:hover {
      background: linear-gradient(135deg, #5b36b1, #7b4cf6);
      transform: translateY(-1px);
    }

    .scoreboard-mini {
      display: flex;
      justify-content: space-around;
      align-items: center;
      font-family: monospace;
      font-size: 1.2em;
    }

    .score-item {
      text-align: center;
      position: relative;
    }

    .score-label {
      font-size: 0.8em;
      opacity: 0.9;
      display: block;
    }

    .score-value {
      font-size: 1.3em;
      font-weight: bold;
      display: block;
      margin-top: 0.2em;
    }

    .mini-crown {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1em;
      animation: crownBounce 1s ease-in-out infinite alternate;
    }

    @keyframes crownBounce {
      0% { transform: translateX(-50%) translateY(0px); }
      100% { transform: translateX(-50%) translateY(-3px); }
    }

    .puzzle-date-mini {
      position: absolute;
      top: 0.5em;
      right: 1em;
      font-size: 0.8em;
      opacity: 0.8;
    }

    /* Scrollable Middle Section */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5em;
      background: #f8f9fa;
      position: relative;
    }

    h1, .subtitle {
      text-align: center;
      margin: 0;
    }

    h1 {
      font-size: 2.2em;
      margin-bottom: 0.2em;
      color: #2d3748;
    }

    .subtitle {
      font-size: 1em;
      color: #666;
      margin-bottom: 2em;
    }

    .user-select-area {
      text-align: center;
      margin-bottom: 2em;
      padding: 1em;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .puzzle-me-container {
      text-align: center;
      margin: 2em 0;
      padding: 1.2em;
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
      display: none;
    }

    .puzzle-me-btn {
      background: white;
      color: #ff6b35;
      border: none;
      padding: 1em 2em;
      border-radius: 25px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .puzzle-me-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .puzzle-me-text {
      color: white;
      margin-bottom: 1em;
      font-size: 1.1em;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    /* Modern Table Styling */
    .table-container {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 2em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1em;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
    }

    th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    th:first-child, td:first-child {
      text-align: left;
      font-weight: 600;
    }

    tr:hover {
      background: #f7fafc;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .puzzle-name {
      cursor: pointer;
      color: #3182ce;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s;
    }

    .puzzle-name:hover {
      color: #2c5282;
      text-decoration: underline;
    }

    .submitted {
      background: #f0fff4;
      padding: 0.5em;
      border-radius: 8px;
      border-left: 4px solid #38a169;
      font-family: monospace;
      font-size: 0.9em;
      white-space: pre-wrap;
    }

    .winner {
      background-color: #d6f5d6 !important;
      border-left-color: #22c55e !important;
    }

    .tie {
      background-color: #fff9c4 !important;
      border-left-color: #eab308 !important;
    }

    .dnf-cell {
      background-color: #ffebee !important;
      color: #dc2626;
      font-weight: bold;
      font-style: italic;
      padding: 0.5em;
      border-left-color: #dc2626 !important;
    }

    textarea {
      width: 100%;
      min-height: 60px;
      padding: 0.75em;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.9em;
      resize: vertical;
      transition: border-color 0.2s;
    }

    textarea:focus {
      outline: none;
      border-color: #3182ce;
      box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
    }

    button {
      background: linear-gradient(135deg, #3182ce, #2c5282);
      color: white;
      border: none;
      padding: 0.75em 1.5em;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 0.5em;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(49, 130, 206, 0.3);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .delete-btn {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      margin-left: 0.5em;
    }

    .delete-btn:hover {
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    /* Bottom Strip - Chat */
    .bottom-strip {
      background: linear-gradient(135deg, #4a4a4a, #667eea);
      color: white;
      padding: 1em 1.5em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 100;
    }

    .bottom-strip:hover {
      background: linear-gradient(135deg, #3a3a3a, #5667da);
      transform: translateY(-1px);
    }

    .chat-indicator {
      display: flex;
      align-items: center;
      gap: 0.5em;
      font-weight: 600;
    }

    .unread-badge {
      background: #dc2626;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7em;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Expanded Overlays */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
    }

    .expanded-panel {
      position: absolute;
      background: white;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .top-expanded {
      top: 0;
      left: 0;
      right: 0;
      height: 75%;
      border-radius: 0 0 16px 16px;
    }

    .bottom-expanded {
      bottom: 0;
      left: 0;
      right: 0;
      height: 75%;
    }

    .panel-header {
      padding: 1.5em;
      font-weight: 600;
      font-size: 1.2em;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .top-expanded .panel-header {
      background: linear-gradient(135deg, #6b46c1, #8b5cf6);
    }

    .bottom-expanded .panel-header {
      background: linear-gradient(135deg, #4a4a4a, #667eea);
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5em;
      cursor: pointer;
      padding: 0.5em;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .panel-content {
      flex: 1;
      padding: 1.5em;
      overflow-y: auto;
      background: #f8f9fa;
    }

    /* History Panel Content */
    .expanded-scoreboard {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      padding: 2em;
      border-radius: 16px;
      margin-bottom: 2em;
      text-align: center;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }

    .expanded-scoreboard .puzzle-date {
      font-size: 1.1em;
      color: #8b4513;
      margin-bottom: 1em;
    }

    .score-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1em;
      margin-bottom: 1em;
    }

    .score-card {
      background: white;
      padding: 1em;
      border-radius: 12px;
      text-align: center;
      position: relative;
    }

    .score-card .label {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 0.5em;
    }

    .score-card .value {
      font-size: 2em;
      font-weight: bold;
      font-family: monospace;
    }

    .history-section {
      background: white;
      border-radius: 16px;
      padding: 1.5em;
      margin-bottom: 1.5em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .history-section h3 {
      margin: 0 0 1em 0;
      color: #2d3748;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 0.5em;
    }

    .winner-card {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      padding: 1.5em;
      border-radius: 12px;
      margin-bottom: 1em;
      text-align: center;
    }

    .winner-name {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 0.5em;
    }

    .streak-info {
      margin: 0.5em 0;
    }

    /* Chat Panel Content */
    .chat-content {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1em;
      background: white;
      margin-bottom: 1em;
      border-radius: 12px;
    }

    .chat-message {
      margin-bottom: 1em;
      display: flex;
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-bubble {
      max-width: 75%;
      padding: 0.75em 1em;
      border-radius: 18px;
      word-wrap: break-word;
    }

    .chat-message.current-user {
      justify-content: flex-end;
    }

    .chat-message.current-user .message-bubble {
      background: linear-gradient(135deg, #3182ce, #2c5282);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-message.other-user .message-bubble {
      background: #e2e8f0;
      color: #2d3748;
      border-bottom-left-radius: 4px;
    }

    .chat-input-area {
      display: flex;
      gap: 0.5em;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 0.75em;
      border: 2px solid #e2e8f0;
      border-radius: 20px;
      font-size: 0.9em;
      resize: none;
      min-height: 40px;
      max-height: 80px;
    }

    .chat-send-btn {
      background: linear-gradient(135deg, #f7931e, #ff6b35);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
    }

    .version {
      text-align: center;
      font-size: 0.8em;
      color: #888;
      margin-top: 2em;
      padding: 1em;
    }

    /* Loading Overlay */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 1.5em;
      color: #666;
    }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .main-content {
        padding: 1em;
      }

      h1 {
        font-size: 1.8em;
      }

      .score-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      th, td {
        padding: 0.75em 0.5em;
        font-size: 0.9em;
      }

      .panel-content {
        padding: 1em;
      }
    }

    @media (max-width: 480px) {
      .scoreboard-mini {
        font-size: 1em;
      }

      .score-value {
        font-size: 1.1em;
      }

      h1 {
        font-size: 1.5em;
      }

      .subtitle {
        font-size: 0.9em;
      }

      th, td {
        padding: 0.5em 0.25em;
        font-size: 0.8em;
      }

      .expanded-panel {
        height: 90% !important;
      }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay">Loading‚Ä¶</div>
  
  <div class="app-container">
    <!-- Top Strip - Scoreboard/History -->
    <div class="top-strip" id="topStrip">
      <div class="puzzle-date-mini" id="puzzleDateMini">2025-05-30 (Fri)</div>
      <div class="scoreboard-mini">
        <div class="score-item">
          <span class="score-label">ACB</span>
          <span class="score-value" id="acbCountMini" style="color: #ffd700;">0</span>
          <span id="acbCrownMini" class="mini-crown" style="display: none;">üëë</span>
        </div>
        <div class="score-item">
          <span class="score-label">JBB</span>
          <span class="score-value" id="jbbCountMini" style="color: #ffd700;">0</span>
          <span id="jbbCrownMini" class="mini-crown" style="display: none;">üëë</span>
        </div>
        <div class="score-item">
          <span class="score-label">Tie</span>
          <span class="score-value" id="tieCountMini">0</span>
        </div>
        <div class="score-item">
          <span class="score-label">Left</span>
          <span class="score-value" id="remainingCountMini">10</span>
        </div>
      </div>
    </div>

    <!-- Scrollable Main Content -->
    <div class="main-content">
      <h1>üß† I'm Puzzled ‚ÄºÔ∏è</h1>
      <div class="subtitle">If you ain't first, you're last</div>

      <div class="user-select-area">
        <label for="userSelect">Signed in as:
          <select id="userSelect">
            <option value="">(choose)</option>
            <option value="Adam">Adam üåµ</option>
            <option value="Jonathan">Jonathan üí©</option>
          </select>
        </label>
      </div>

      <div class="puzzle-me-container" id="puzzleMeContainer">
        <div class="puzzle-me-text">Ready for a new day of puzzle competition?</div>
        <button class="puzzle-me-btn" id="puzzleMeBtn">üß© Puzzle Me! üß©</button>
      </div>

      <div class="table-container">
        <table id="puzzleTable">
          <thead>
            <tr><th>Puzzle</th><th>Adam üåµ</th><th>Jonathan üí©</th></tr>
          </thead>
          <tbody id="puzzleRows">
            <tr data-puzzle="Connections"><td><span class="puzzle-name" data-url="https://www.nytimes.com/games/connections">Connections</span></td><td data-cell="Connections-Adam"></td><td data-cell="Connections-Jonathan"></td></tr>
            <tr data-puzzle="Strands"><td><span class="puzzle-name" data-url="https://www.nytimes.com/games/strands">Strands</span></td><td data-cell="Strands-Adam"></td><td data-cell="Strands-Jonathan"></td></tr>
            <tr data-puzzle="On the Record"><td><span class="puzzle-name" data-url="https://www.washingtonpost.com/news-quiz/">On the Record</span></td><td data-cell="On the Record-Adam"></td><td data-cell="On the Record-Jonathan"></td></tr>
            <tr data-puzzle="Keyword"><td><span class="puzzle-name" data-url="https://washingtonpost.com/games/keyword/">Keyword</span></td><td data-cell="Keyword-Adam"></td><td data-cell="Keyword-Jonathan"></td></tr>
            <tr data-puzzle="NYT Mini"><td><span class="puzzle-name" data-url="https://nytimes.com/crosswords/game/mini/">NYT Mini</span></td><td data-cell="NYT Mini-Adam"></td><td data-cell="NYT Mini-Jonathan"></td></tr>
            <tr data-puzzle="Apple Mini"><td><span class="puzzle-name" data-url="https://apple.news/puzzles">Apple Mini</span></td><td data-cell="Apple Mini-Adam"></td><td data-cell="Apple Mini-Jonathan"></td></tr>
            <tr data-puzzle="Globle"><td><span class="puzzle-name" data-url="https://globle-game.com">Globle</span></td><td data-cell="Globle-Adam"></td><td data-cell="Globle-Jonathan"></td></tr>
            <tr data-puzzle="Flagle"><td><span class="puzzle-name" data-url="https://www.flagle.io">Flagle</span></td><td data-cell="Flagle-Adam"></td><td data-cell="Flagle-Jonathan"></td></tr>
            <tr data-puzzle="Wordle"><td><span class="puzzle-name" data-url="https://www.nytimes.com/games/wordle/index.html">Wordle</span></td><td data-cell="Wordle-Adam"></td><td data-cell="Wordle-Jonathan"></td></tr>
            <tr data-puzzle="Tightrope"><td><span class="puzzle-name" data-url="https://www.britannica.com/quiz/tightrope">Tightrope</span></td><td data-cell="Tightrope-Adam"></td><td data-cell="Tightrope-Jonathan"></td></tr>
          </tbody>
        </table>
      </div>

      <div class="version">v2025.05.30.2 - Phase 3B: Claude-Style Interface! üé®‚ú®</div>
    </div>

    <!-- Bottom Strip - Chat -->
    <div class="bottom-strip" id="bottomStrip" style="display: none;">
      <div class="chat-indicator">
        <span>üí¨ Trash Talk Central üóëÔ∏è</span>
        <span id="unreadBadge" class="unread-badge" style="display: none;">0</span>
      </div>
      <div style="font-size: 0.8em; opacity: 0.8;">Tap to expand</div>
    </div>
  </div>

  <!-- Top Expanded Panel - History/Scoreboard -->
  <div class="overlay" id="topOverlay">
    <div class="expanded-panel top-expanded">
      <div class="panel-header">
        <span>üß© History & Stats üìä</span>
        <button class="close-btn" id="topCloseBtn">‚úï</button>
      </div>
      <div class="panel-content">
        <div class="expanded-scoreboard">
          <div class="puzzle-date" id="puzzleDateExpanded">2025-05-30 (Fri)</div>
          <div class="score-grid">
            <div class="score-card">
              <div class="label">ACB</div>
              <div class="value" id="acbCountExpanded" style="color: #ffd700;">0</div>
              <span id="acbCrownExpanded" class="mini-crown" style="display: none;">üëë</span>
            </div>
            <div class="score-card">
              <div class="label">JBB</div>
              <div class="value" id="jbbCountExpanded" style="color: #ffd700;">0</div>
              <span id="jbbCrownExpanded" class="mini-crown" style="display: none;">üëë</span>
            </div>
            <div class="score-card">
              <div class="label">Ties</div>
              <div class="value" id="tieCountExpanded">0</div>
            </div>
            <div class="score-card">
              <div class="label">Remaining</div>
              <div class="value" id="remainingCountExpanded">10</div>
            </div>
          </div>
        </div>

        <div class="history-section">
          <h3>Most Recent Daily Winner</h3>
          <div class="winner-card">
            <div class="winner-name" id="lastOverallWinner">Loading...</div>
            <div class="streak-info" id="overallStreak">Calculating streak...</div>
            <div class="streak-info" id="overallLongestStreak">Longest streak: Loading...</div>
          </div>
        </div>

        <div class="history-section">
          <h3>Individual Puzzle Streaks</h3>
          <div id="puzzleStreaks">Loading puzzle streaks...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Expanded Panel - Chat -->
  <div class="overlay" id="bottomOverlay">
    <div class="expanded-panel bottom-expanded">
      <div class="panel-header">
        <span>üí¨ Trash Talk Central üóëÔ∏è</span>
        <button class="close-btn" id="bottomCloseBtn">‚úï</button>
      </div>
      <div class="panel-content">
        <div class="chat-content">
          <div class="chat-messages" id="chatMessages">
            <div style="text-align: center; color: #888; font-style: italic; padding: 2em;">
              No trash talk yet... someone needs to start the smack down! üî•
            </div>
          </div>
          <div class="chat-input-area">
            <textarea id="chatInput" class="chat-input" placeholder="Drop some trash talk... üî•" maxlength="500" disabled></textarea>
            <button id="chatSendBtn" class="chat-send-btn" disabled>üöÆ</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script type="module">
    console.log('üß† I\'m Puzzled v2025.05.30.2 - Claude-Style Interface');
    
    // Global state
    let currentPuzzleDate = null;

    // Date functions
    function getCurrentDate() {
      return new Date().toISOString().slice(0, 10);
    }

    function formatDateDisplay(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const dayName = days[date.getDay()];
      return `${dateStr} (${dayName})`;
    }

    function updatePuzzleDateDisplay(dateStr = null) {
      const displayDate = dateStr || getCurrentDate();
      currentPuzzleDate = displayDate;
      const formatted = formatDateDisplay(displayDate);
      
      document.getElementById('puzzleDateMini').textContent = formatted;
      document.getElementById('puzzleDateExpanded').textContent = formatted;
      
      updatePuzzleMeButtonVisibility();
    }

    function updatePuzzleMeButtonVisibility() {
      const container = document.getElementById('puzzleMeContainer');
      const currentDate = getCurrentDate();
      
      if (currentPuzzleDate && currentPuzzleDate < currentDate) {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }

    // Enhanced scoreboard that updates BOTH mini and expanded views
    window.enhancedUpdateScoreboard = function(acb, jbb, tie, remaining) {
      // Update ALL scoreboard displays
      const scoreElements = [
        { acb: 'acbCountMini', jbb: 'jbbCountMini', tie: 'tieCountMini', remaining: 'remainingCountMini', 
          acbCrown: 'acbCrownMini', jbbCrown: 'jbbCrownMini' },
        { acb: 'acbCountExpanded', jbb: 'jbbCountExpanded', tie: 'tieCountExpanded', remaining: 'remainingCountExpanded', 
          acbCrown: 'acbCrownExpanded', jbbCrown: 'jbbCrownExpanded' }
      ];

      scoreElements.forEach(set => {
        const acbEl = document.getElementById(set.acb);
        const jbbEl = document.getElementById(set.jbb);
        const tieEl = document.getElementById(set.tie);
        const remainingEl = document.getElementById(set.remaining);
        const acbCrown = document.getElementById(set.acbCrown);
        const jbbCrown = document.getElementById(set.jbbCrown);

        if (acbEl) acbEl.textContent = acb;
        if (jbbEl) jbbEl.textContent = jbb;
        if (tieEl) tieEl.textContent = tie;
        if (remainingEl) remainingEl.textContent = remaining;

        // Reset crowns
        if (acbCrown) acbCrown.style.display = "none";
        if (jbbCrown) jbbCrown.style.display = "none";

        // Apply color logic - FIXED: Always yellow for ties including 0-0
        if (acbEl && jbbEl) {
          const canAcbWin = acb + remaining > jbb;
          const canJbbWin = jbb + remaining > acb;

          if (acb > jbb && !canJbbWin) {
            // ACB has mathematically won
            acbEl.style.color = "green";
            jbbEl.style.color = "red";
            if (acbCrown) acbCrown.style.display = "block";
          } else if (jbb > acb && !canAcbWin) {
            // JBB has mathematically won
            jbbEl.style.color = "green";
            acbEl.style.color = "red";
            if (jbbCrown) jbbCrown.style.display = "block";
          } else if (acb > jbb) {
            // ACB currently leading
            acbEl.style.color = "green";
            jbbEl.style.color = "red";
          } else if (jbb > acb) {
            // JBB currently leading
            jbbEl.style.color = "green";
            acbEl.style.color = "red";
          } else {
            // FIXED: Tied scores (including 0-0) ALWAYS show in yellow
            acbEl.style.color = "#ffd700";
            jbbEl.style.color = "#ffd700";
          }
        }
      });
    };

    // Initialize Puzzle Me button
    function initializePuzzleMeButton() {
      const button = document.getElementById('puzzleMeBtn');
      
      button.addEventListener('click', () => {
        const newDate = getCurrentDate();
        updatePuzzleDateDisplay(newDate);
        
        if (window.appInstance && window.appInstance.startNewDay) {
          window.appInstance.startNewDay();
        }
        
        console.log('üß© New puzzle day started!');
      });
    }

    // Claude-style interface controls
    function setupClaudeInterface() {
      const topStrip = document.getElementById('topStrip');
      const bottomStrip = document.getElementById('bottomStrip');
      const topOverlay = document.getElementById('topOverlay');
      const bottomOverlay = document.getElementById('bottomOverlay');
      const topCloseBtn = document.getElementById('topCloseBtn');
      const bottomCloseBtn = document.getElementById('bottomCloseBtn');

      // Top strip - expand history/scoreboard
      topStrip.addEventListener('click', () => {
        topOverlay.style.display = 'block';
        document.body.style.overflow = 'hidden';
        if (window.updateHistoryModal) {
          window.updateHistoryModal({});
        }
      });

      // Bottom strip - expand chat
      bottomStrip.addEventListener('click', () => {
        bottomOverlay.style.display = 'block';
        document.body.style.overflow = 'hidden';
        if (window.chatSystem) {
          window.chatSystem.isVisible = true;
          window.chatSystem.markAsRead();
        }
      });

      // Close buttons
      topCloseBtn.addEventListener('click', () => {
        topOverlay.style.display = 'none';
        document.body.style.overflow = '';
      });

      bottomCloseBtn.addEventListener('click', () => {
        bottomOverlay.style.display = 'none';
        document.body.style.overflow = '';
        if (window.chatSystem) {
          window.chatSystem.isVisible = false;
          window.chatSystem.updateUnreadBadge();
        }
      });

      // Overlay click to close
      topOverlay.addEventListener('click', (e) => {
        if (e.target === topOverlay) {
          topOverlay.style.display = 'none';
          document.body.style.overflow = '';
        }
      });

      bottomOverlay.addEventListener('click', (e) => {
        if (e.target === bottomOverlay) {
          bottomOverlay.style.display = 'none';
          document.body.style.overflow = '';
          if (window.chatSystem) {
            window.chatSystem.isVisible = false;
            window.chatSystem.updateUnreadBadge();
          }
        }
      });

      // Escape key closes overlays
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (topOverlay.style.display === 'block') {
            topOverlay.style.display = 'none';
            document.body.style.overflow = '';
          }
          if (bottomOverlay.style.display === 'block') {
            bottomOverlay.style.display = 'none';
            document.body.style.overflow = '';
            if (window.chatSystem) {
              window.chatSystem.isVisible = false;
              window.chatSystem.updateUnreadBadge();
            }
          }
        }
      });
    }

    // Enhanced history modal for Claude-style interface
    window.updateHistoryModal = function(historyData) {
      // Calculate current streaks and longest streaks (simplified for demo)
      const streaks = {
        overall: {
          current: { winner: 'Adam', count: 3 },
          longest: { count: 5, holders: ['Adam'] }
        },
        puzzles: {
          'Connections': {
            current: { winner: 'Jonathan', count: 2 },
            longest: { count: 4, holders: ['Jonathan'] }
          },
          'Wordle': {
            current: { winner: 'Adam', count: 1 },
            longest: { count: 7, holders: ['Adam', 'Jonathan'] }
          }
        }
      };
      
      // Update overall winner section
      const lastWinnerEl = document.getElementById('lastOverallWinner');
      const overallStreakEl = document.getElementById('overallStreak');
      const overallLongestEl = document.getElementById('overallLongestStreak');
      
      if (lastWinnerEl && overallStreakEl && overallLongestEl) {
        if (streaks.overall.current.winner) {
          lastWinnerEl.textContent = streaks.overall.current.winner;
          overallStreakEl.textContent = `Current streak: ${streaks.overall.current.count} day${streaks.overall.current.count !== 1 ? 's' : ''}`;
          
          const longestRecord = streaks.overall.longest;
          if (longestRecord.count > 0) {
            const holderText = longestRecord.holders.length > 1 
              ? longestRecord.holders.join(' & ') 
              : longestRecord.holders[0];
            overallLongestEl.textContent = `Longest streak: ${longestRecord.count} days (${holderText})`;
          } else {
            overallLongestEl.textContent = 'Longest streak: No records yet';
          }
        } else {
          lastWinnerEl.textContent = 'No winner yet';
          overallStreakEl.textContent = 'No current streak';
          overallLongestEl.textContent = 'Longest streak: No records yet';
        }
      }
      
      // Update puzzle streaks section
      const puzzleStreaksEl = document.getElementById('puzzleStreaks');
      if (puzzleStreaksEl) {
        puzzleStreaksEl.innerHTML = '';
        
        const puzzles = ['Connections', 'Strands', 'On the Record', 'Keyword', 'NYT Mini', 
                        'Apple Mini', 'Globle', 'Flagle', 'Wordle', 'Tightrope'];
        
        puzzles.forEach(puzzle => {
          const puzzleStreak = streaks.puzzles[puzzle];
          const item = document.createElement('div');
          item.className = 'history-section';
          item.style.marginBottom = '1em';
          item.style.padding = '1em';
          
          let currentText = 'No current streak';
          let longestText = 'No records yet';
          
          if (puzzleStreak) {
            const current = puzzleStreak.current;
            const longest = puzzleStreak.longest;
            
            currentText = current.winner 
              ? `${current.winner}: ${current.count} day${current.count !== 1 ? 's' : ''}`
              : 'No current streak';
              
            if (longest.count > 0) {
              const holderText = longest.holders.length > 1 
                ? longest.holders.join(' & ') 
                : longest.holders[0];
              longestText = `Record: ${longest.count} days (${holderText})`;
            }
          }
          
          item.innerHTML = `
            <h4 style="margin: 0 0 0.5em 0; color: #2d3748;">${puzzle}</h4>
            <div style="color: #666; margin-bottom: 0.25em;">${currentText}</div>
            <div style="color: #999; font-size: 0.9em; font-style: italic;">${longestText}</div>
          `;
          
          puzzleStreaksEl.appendChild(item);
        });
      }
    };

    // Setup chat system for Claude-style interface
    function setupClaudeChat() {
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');

      if (chatSendBtn) {
        chatSendBtn.addEventListener('click', () => {
          if (window.chatSystem) {
            window.chatSystem.sendMessage();
          }
        });
      }

      if (chatInput) {
        chatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (window.chatSystem) {
              window.chatSystem.sendMessage();
            }
          }
        });

        chatInput.addEventListener('input', () => {
          const hasText = chatInput.value.trim().length > 0;
          const currentUser = window.userManager ? window.userManager.getCurrentUser() : null;
          if (chatSendBtn) {
            chatSendBtn.disabled = !hasText || !currentUser;
          }
        });
      }
    }

    // Global functions for modules
    window.createDNFCell = function() {
      const div = document.createElement('div');
      div.className = 'dnf-cell';
      div.textContent = 'DNF';
      return div;
    };

    window.DEADLINE_CONFIG = {
      'Connections': { resetTime: '00:00', timezone: 'local', gracePeriod: 15 },
      'Strands': { resetTime: '00:00', timezone: 'local', gracePeriod: 15 },
      'On the Record': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15, weekendExtended: true },
      'Keyword': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15 },
      'NYT Mini': { resetTime: '22:00', timezone: 'ET', gracePeriod: 15, weekendTime: '18:00' },
      'Apple Mini': { resetTime: '00:00', timezone: 'local', gracePeriod: 15 },
      'Globle': { resetTime: '00:00', timezone: 'local', gracePeriod: 15 },
      'Flagle': { resetTime: '00:00', timezone: 'local', gracePeriod: 15 },
      'Wordle': { resetTime: '00:00', timezone: 'local', gracePeriod: 15 },
      'Tightrope': { resetTime: '00:00', timezone: 'local', gracePeriod: 15 }
    };

    // Initialize everything
    updatePuzzleDateDisplay();
    initializePuzzleMeButton();
    setupClaudeInterface();
    setupClaudeChat();
    
    import('./modules/core/supabase-client.js').then(async (supabaseModule) => {
      console.log('‚úÖ Supabase module loaded');
      
      const supabaseClient = supabaseModule.default;
      window.supabase = supabaseClient.getClient();
      window.supabaseClient = supabaseClient;
      
      const isHealthy = await supabaseClient.testConnection();
      if (!isHealthy) {
        console.error('‚ùå Database connection failed');
        document.getElementById('loadingOverlay').style.display = 'none';
        return;
      }
      
      const { default: app } = await import('./modules/app/main.js');
      
      // ENHANCED: Inject Claude-style functionality into modules
      app.updatePuzzleDateDisplay = updatePuzzleDateDisplay;
      app.enhancedUpdateScoreboard = window.enhancedUpdateScoreboard;
      app.createDNFCell = window.createDNFCell;
      app.DEADLINE_CONFIG = window.DEADLINE_CONFIG;
      app.updateHistoryModal = window.updateHistoryModal;
      
      // Override module methods for Claude-style interface
      app.startNewDay = function() {
        console.log('üÜï Starting new puzzle day...');
        const newDate = getCurrentDate();
        updatePuzzleDateDisplay(newDate);
        
        if (app.resetForNewDay) {
          app.resetForNewDay();
        }
      };
      
      // CRITICAL: Override scoreboard update to use enhanced version
      const originalHandleResultsUpdate = app.handleResultsUpdate.bind(app);
      app.handleResultsUpdate = function(payload) {
        originalHandleResultsUpdate(payload);
        
        // Force enhanced scoreboard update for real-time sync
        if (app.modules && app.modules.scoreboard) {
          const scores = app.modules.scoreboard.getScores();
          window.enhancedUpdateScoreboard(scores.acb, scores.jbb, scores.tie, scores.remaining);
        }
      };
      
      await app.init();
      window.appInstance = app;
      
      // Show interface elements after successful init
      const userManager = app.modules.userManager;
      if (userManager && userManager.canRenderTable()) {
        document.getElementById('bottomStrip').style.display = 'flex';
      }
      
      // Override chat system for Claude interface
      if (app.modules.chatSystem) {
        const originalShowChat = app.modules.chatSystem.showChat.bind(app.modules.chatSystem);
        const originalHideChat = app.modules.chatSystem.hideChat.bind(app.modules.chatSystem);
        const originalRenderMessages = app.modules.chatSystem.renderMessages.bind(app.modules.chatSystem);
        
        app.modules.chatSystem.showChat = function() {
          document.getElementById('bottomOverlay').style.display = 'block';
          document.body.style.overflow = 'hidden';
          this.isVisible = true;
          this.markAsRead();
        };
        
        app.modules.chatSystem.hideChat = function() {
          document.getElementById('bottomOverlay').style.display = 'none';
          document.body.style.overflow = '';
          this.isVisible = false;
          this.updateUnreadBadge();
        };
        
        app.modules.chatSystem.updateUnreadBadge = function() {
          const unreadBadge = document.getElementById('unreadBadge');
          if (!unreadBadge) return;
          
          if (this.isVisible) {
            unreadBadge.style.display = 'none';
            return;
          }
          
          const unreadMessages = this.messages.filter(msg => {
            if (msg.player === this.currentUser || msg.message === '[deleted]') return false;
            if (this.lastReadMessageId && msg.id <= this.lastReadMessageId) return false;
            return true;
          });
          
          if (unreadMessages.length > 0) {
            unreadBadge.textContent = unreadMessages.length;
            unreadBadge.style.display = 'flex';
            this.hasUnreadMessages = true;
          } else {
            unreadBadge.style.display = 'none';
            this.hasUnreadMessages = false;
          }
        };
      }
      
      console.log('üéâ Phase 3B Complete! Claude-style interface with enhanced real-time updates');
      
    }).catch(error => {
      console.error('üí• Module loading failed:', error);
      document.getElementById('loadingOverlay').style.display = 'none';
      
      document.body.innerHTML += `
        <div style="text-align: center; padding: 2em; color: #666; background: #f5f5f5; border-radius: 8px; margin: 2em;">
          <h2>‚ö†Ô∏è Module Loading Failed</h2>
          <p>The modular framework could not load. Please ensure all module files are present.</p>
          <p><strong><a href="index-v0.6.1.html">Click here for the backup v0.6.1 version</a></strong></p>
        </div>
      `;
    });
  </script>
</body>
</html>