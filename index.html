<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üß† I'm Puzzled ‚ÄºÔ∏è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <style>
    :root {
      /* Phase 3C Color Palette */
      --primary-light: #f8fafc;
      --primary-medium: #e2e8f0;
      --purple-light: #ddd6fe;
      --purple-medium: #c4b5fd;
      --purple-dark: #6b46c1;
      --accent-dark: #475569;
      --strip-bg: #ddd6fe;
      --table-header: #f1f5f9;
      --swipe-indicator: #6b46c1;
    }

    /* Remove the thin line when top strip is expanded */
    .top-strip.expanded {
      border-bottom: none !important;
    }

    .top-strip.expanded .scoreboard-mini {
      border-bottom: none !important;
    }

    .top-strip.expanded .scoreboard-container {
      border-bottom: none !important;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--primary-light);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Update your .top-strip rule to ensure it doesn't move */
.top-strip {
  position: fixed;
  top: 0 !important; /* Force it to stay at top */
  left: 0;
  right: 0;
  background: var(--strip-bg);
  border-bottom: 1px solid var(--purple-medium);
  z-index: 1001; /* Higher than bottom strip */
  transition: height 0.3s ease;
  height: 140px;
  box-shadow: 0 2px 8px rgba(107, 70, 193, 0.1);
}

    /* FIXED: Edge-to-edge expansion - stops at top of bottom strip */
.top-strip.expanded {
  height: calc(100vh - 70px);
  bottom: 70px; /* Stop above bottom strip */
}

    /* Replace your existing .bottom-strip rule with this enhanced version */
.bottom-strip {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--strip-bg);
  border-top: 1px solid var(--purple-medium);
  z-index: 1000;
  height: calc(100vh - 140px); /* Always full height */
  box-shadow: 0 -2px 8px rgba(107, 70, 193, 0.1);
  padding-top: 10px;
  clip-path: polygon(0 calc(100% - 70px), 100% calc(100% - 70px), 100% 100%, 0 100%);
  transition: clip-path 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Smooth expansion using clip-path */
.bottom-strip.expanded {
  clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
}


    /* FIXED: Main Content Area with proper positioning */
    .main-content {
      flex: 1;
      margin-top: 140px; /* FIXED: Exact height of top strip */
      margin-bottom: 70px; /* FIXED: Exact height of bottom strip */
      overflow-y: auto;
      padding: 1em;
      -webkit-overflow-scrolling: touch;
      position: relative;
      /* FIXED: Ensure no grey bands by removing extra spacing */
      min-height: calc(100vh - 210px); /* Total height minus both strips */
    }

    /* ENHANCED: Dynamic adjustment when strips are expanded */
    .main-content.top-expanded {
      margin-top: calc(100vh - 70px);
      min-height: 0;
    }

    .main-content.bottom-expanded {
  margin-bottom: calc(100vh - 140px);
  margin-top: 140px; /* Keep below top strip */
  min-height: 0;
}

    .main-content.both-collapsed {
      margin-top: 140px;
      margin-bottom: 70px;
      min-height: calc(100vh - 210px);
    }

    /* Overlay for tap-to-dismiss functionality */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 999;
      display: none;
      cursor: pointer;
    }

    .overlay.visible {
      display: block;
    }

    /* Swipe Indicators */
    .swipe-indicator {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 4px;
      background: var(--swipe-indicator);
      border-radius: 2px;
      opacity: 0.6;
      transition: all 0.3s ease;
      cursor: pointer;
      z-index: 1001;
    }

    .top-strip .swipe-indicator {
      bottom: 10px;
    }

    .bottom-strip .swipe-indicator {
      top: 10px;
    }

    .swipe-indicator:hover {
      opacity: 1;
      transform: translateX(-50%) scale(1.1);
    }

    /* ENHANCED SCOREBOARD (Top Strip Content) */
    .scoreboard-container {
      padding: 2em 1em 1em 1em;
      height: 100%;
      overflow: hidden;
    }

    .scoreboard-mini {
      display: flex;
      justify-content: space-around;
      align-items: center;
      font-weight: 600;
      font-size: 1.4em;
      height: 80px;
    }

    .scoreboard-item {
      text-align: center;
      position: relative;
      min-width: 70px;
      margin-top: 30px;
    }

    .scoreboard-label {
      font-size: 0.8em;
      color: var(--accent-dark);
      margin-bottom: 4px;
      font-weight: 800;
    }

    .scoreboard-value {
  font-size: 1.8em;
  font-weight: 900;
  color: var(--purple-dark);
  font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace !important;
  letter-spacing: 0.05em;
  font-variant-numeric: tabular-nums;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Add this new rule right after the .scoreboard-value rule */
#acbCount, #jbbCount, #tieCount, #remainingCount {
  font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace !important;
  font-variant-numeric: tabular-nums;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

    .crown {
      position: absolute;
      top: -60px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2.5em;
      animation: crownBounce 1s ease-in-out infinite alternate;
    }

    @keyframes crownBounce {
      0% { transform: translateX(-50%) translateY(0px); }
      100% { transform: translateX(-50%) translateY(-3px); }
    }

    /* FIXED: History expansion with proper bottom constraint and visual divider */
.history-expanded {
  display: none;
  padding: 1em;
  padding-top: 0.5em;
  overflow-y: auto;
  position: absolute;
  top: 140px; /* Start below the entire top strip (140px) */
  left: 0;
  right: 0;
  bottom: 80px; /* Increased to 80px for Safari */
  -webkit-overflow-scrolling: touch; /* Better iOS scrolling */
}

/* Safari-specific fix for proper bottom spacing */
@supports (-webkit-touch-callout: none) {
  .history-expanded {
    bottom: 85px; /* Extra padding for Safari */
    padding-bottom: 10px;
  }
}

    .top-strip.expanded .history-expanded {
  display: block;
}

/* Add purple divider line at 140px (same as collapsed strip height) */
.top-strip.expanded::after {
  content: '';
  position: absolute;
  top: 140px;
  left: 0;
  right: 0;
  height: 1px;
  background: var(--purple-dark);
  z-index: 5;
}
    
    /* Ensure scoreboard stays at top when history is expanded */
.top-strip.expanded .scoreboard-mini {
  position: relative;
  z-index: 10;
}

    .top-strip.expanded .scoreboard-mini {
      height: 80px;
      border-bottom: 1px solid var(--purple-medium);
      margin-bottom: 1em;
    }

    .history-title {
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      color: var(--purple-dark);
      margin-bottom: 1.5em;
    }

    /* Current Champ Panel */
    .current-champ-panel {
      background: white;
      border-radius: 12px;
      padding: 1.5em;
      margin-bottom: 1.5em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--purple-medium);
    }

    .current-champ-title {
      text-align: center;
      font-size: 1.2em;
      font-weight: 700;
      color: var(--purple-dark);
      margin-bottom: 1em;
    }

    .champ-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75em 1em;
      background: linear-gradient(135deg, var(--purple-light), var(--purple-medium));
      border-radius: 8px;
    }

    .champ-name {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--purple-dark);
    }

    .champ-streak {
      font-size: 0.9em;
      color: var(--accent-dark);
      font-weight: 500;
    }

    /* DATE PICKER */
    .date-picker-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1em;
      margin-bottom: 1.5em;
      padding: 1em;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .date-picker {
      padding: 0.5em 1em;
      border: 2px solid var(--purple-medium);
      border-radius: 8px;
      font-size: 1em;
      background: white;
    }

    .date-nav-btn {
      background: var(--purple-medium);
      color: var(--purple-dark);
      border: none;
      padding: 0.5em 1em;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .date-nav-btn:hover {
      background: var(--purple-dark);
      color: white;
    }

    /* HISTORY TABLE */
    .history-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .history-table th {
      background: var(--table-header);
      padding: 0.75em;
      text-align: left;
      font-weight: 600;
      color: var(--accent-dark);
      border-bottom: 2px solid var(--primary-medium);
    }

    .history-table td {
      padding: 0.75em;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }

    .history-table tr:last-child td {
      border-bottom: none;
    }

    .history-table tr:hover {
      background: #f8fafc;
    }

    .streak-current {
      font-weight: 600;
      color: var(--purple-dark);
    }

    .streak-record {
      font-weight: 500;
      color: #059669;
    }

    /* FIXED: Chat System with proper bottom padding */
.chat-container {
  padding: 1em;
  padding-bottom: 1.5em; /* Added aesthetic bottom padding */
  height: 100%;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}            
    
    .chat-mini {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 50px;
      position: relative;
    }

    .chat-indicator {
      font-size: 1.5em;
      color: var(--purple-dark);
      padding-top: 10px;
      padding-bottom: 5px;
    }

    .chat-status {
      flex: 1;
      font-weight: 600;
      color: var(--accent-dark);
      font-size: 1.1em;
      position: relative;
      text-align: center;
    }
    
    #unreadBadge {
  position: absolute;
  top: 5px;
  right: 20px;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  border-radius: 50%;
  min-width: 22px;
  height: 22px;
  font-size: 0.75em;
  font-weight: bold;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1003;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
  animation: pulse 2s ease infinite;
}
    
    /* Swipe indicator for chat-mini */
.chat-mini .swipe-indicator {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 4px;
  background: var(--swipe-indicator);
  border-radius: 2px;
  opacity: 0.6;
  cursor: pointer;
}

.chat-mini .swipe-indicator:hover {
  opacity: 1;
  transform: translateX(-50%) scale(1.1);
}

    /* FIXED: Chat expanded with proper height and bottom padding */
.chat-expanded {
  display: flex !important; /* Always display */
  padding: 1em;
  padding-top: 1em; /* Normal padding since we have a real header now */
  padding-bottom: 1.5em;
  height: 100%;
  flex-direction: column;
  overflow: hidden;
  justify-content: space-between;
  opacity: 0;
  transition: opacity 0.3s ease 0.1s;
}

    .bottom-strip.expanded .chat-expanded {
      opacity: 1;
    }
    
    /* Override chat-system.js inline styles */
    .chat-messages {
      transition: none !important;
    }
    
    .bottom-strip:not(.expanded) .chat-messages {
      opacity: 0 !important;
      visibility: hidden !important;
    }

    .bottom-strip.expanded .chat-mini {
      height: 50px;
      flex-shrink: 0;
    }
    
    /* Chat expanded header - MINIMAL changes */
    .chat-expanded-header {
      height: 70px;
      background: var(--strip-bg);
      border-bottom: none;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-shrink: 0;
      padding-top: 15px; /* Reduced padding to show sipe indicator better */
    }

    .chat-expanded-header .swipe-indicator {
      position: absolute;
      top: 23px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px !important;
      height: 4px !important;
      background: var(--purple-dark) !important;
      border-radius: 2px;
      opacity: 0.6;
      cursor: pointer;
      z-index: 10;
    }

    .chat-expanded-header .swipe-indicator:hover {
      opacity: 1;
      transform: translateX(-50%) scale(1.1);
    }

    .chat-header-text {
      font-weight: 600;
      color: var(--accent-dark);
      font-size: 1.1em;
    }

    /* Hide chat-mini when expanded */
    .bottom-strip.expanded .chat-mini {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }

    /* Ensure chat-expanded fills properly without breaking layout */
    .bottom-strip.expanded .chat-expanded {
      display: flex;
      flex-direction: column;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--strip-bg); /* Ensure background covers everything */
    }

    /* ENHANCED: Chat messages with proper scrolling */
    .chat-messages {
      flex: 1 1 0;
      min-height: 0;
      overflow-y: auto;
      text-align: center;
      padding: 1em;
      background: white;
      border-radius: 8px;
      margin-top: 10px;
      margin-bottom: 10px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      /* FIXED: Ensure chat content is visible */
      min-height: 200px;
    }
    
    /* Fix iOS scrolling issues */
    .chat-messages {
      -webkit-overflow-scrolling: touch;
      overflow-x: hidden;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }
    
    /* Apply to all scrollable containers */
    .history-expanded,
    .chat-expanded,
    .main-content {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }
    
    /* Prevent body scroll when modals are open */
    body.modal-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }

    /* Modern chat bubbles */
    .chat-message {
      margin-bottom: 1em;
      display: flex;
      flex-direction: column;
    }

    .message-bubble {
      max-width: 75%;
      word-wrap: break-word;
      padding: 0.75em 1em;
      border-radius: 16px;
      margin: 0.25em 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s;
      width: fit-content;
    }

    .message-bubble.current-user {
      background: linear-gradient(135deg, #6b46c1, #8b5cf6);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message-bubble.other-user {
      background: #f8fafc;
      color: var(--accent-dark);
      align-self: flex-start;
      border: 1px solid var(--primary-medium);
      border-bottom-left-radius: 4px;
    }

    .message-bubble:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .chat-input-container {
      display: flex;
      gap: 0.5em;
      padding: 1em;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
      margin-top: auto;
    }
    
    /* Prevent chat area from triggering collapse */
    .chat-expanded,
    .chat-input-container,
    .chat-messages,
    .chat-input,
    .chat-send-btn {
      pointer-events: auto !important;
      position: relative;
      z-index: 1005; /* Higher than strip */
    }
    
    /* Ensure input area is always interactive */
    .bottom-strip.expanded .chat-input-container {
      position: relative;
      z-index: 1006;
      pointer-events: auto !important;
    }

    .chat-input {
      flex: 1;
      padding: 0.75em;
      border: 2px solid var(--purple-medium);
      border-radius: 6px;
      font-size: 1em;
      resize: none;
    }

    .chat-send-btn {
      background: transparent !important;
      border: none;
      padding: 0.1em;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
      font-size: 2.5em;
      min-width: 50px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      color: inherit !important;
      filter: none !important;
      opacity: 1 !important;
      -webkit-appearance: none !important;
      appearance: none !important;
    }

    .chat-send-btn:hover {
      background: rgba(107, 70, 193, 0.1) !important;
      transform: scale(1.05);
    }

    .chat-send-btn:disabled {
      cursor: not-allowed;
      filter: grayscale(100%) opacity(50%) !important;
    }
    
    .chat-send-btn:focus {
      outline: none;
      box-shadow: none;
    }
    
    .chat-send-btn:active {
      transform: scale(0.95);
    }
    
    .chat-send-btn:active,
    .chat-send-btn:focus,
    .chat-send-btn:hover,
    .chat-send-btn:visited {
      background: transparent !important;
      filter: none !important;
      opacity: 1 !important;
    }
    
    /* Force emoji to ALWAYS stay colorful no matter what */
    #chatSendBtn {
      color: initial !important;
      -webkit-text-fill-color: initial !important;
      filter: none !important;
      opacity: 1 !important;
    }
    
    #chatSendBtn * {
      color: inherit !important;
      -webkit-text-fill-color: initial !important;
      filter: none !important;
      opacity: 1 !important;
    }
    
    /* Ensure emoji stays colorful when not disabled */
    .chat-send-btn:not(:disabled) {
      filter: none !important;
      opacity: 1 !important;
      -webkit-text-fill-color: initial !important;
      color: initial !important;
    }
    
    /* Force colorful emoji in span */
    .chat-send-btn span {
      color: inherit !important;
      filter: none !important;
      opacity: 1 !important;
      -webkit-text-fill-color: initial !important;
    }

    /* MAIN CONTENT STYLING */
    h1 {
      text-align: center;
      margin: 0 0 0.5em 0;
      font-size: 2em;
      color: var(--purple-dark);
    }

    .subtitle {
      text-align: center;
      font-size: 0.95em;
      color: #666;
      margin: 0 0 0.75em 0;
    }
    
    /* iOS dropdown display fix */
    .user-select {
      -webkit-appearance: menulist;
      -moz-appearance: menulist;
      appearance: menulist;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 14px;
      min-width: 120px;
    }

    .user-select option {
      background-color: white;
      color: black;
    }

    .user-select-area {
  text-align: center;
  margin: 1.125em 0 1.125em 0; /* Centered between subtitle and date */
}

    .user-select-area select {
      padding: 0.5em 1em;
      border: 2px solid var(--purple-medium);
      border-radius: 8px;
      background: white;
      font-size: 1em;
    }

    .puzzle-date {
      text-align: center;
      font-size: 0.9em;
      color: #888;
      margin: 0.5em 0 1.5em 0;
      font-weight: 500;
    }

    /* PUZZLE TABLE */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1em 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th {
      background: var(--table-header);
      padding: 0.75em 0.5em;
      text-align: center;
      font-weight: 600;
      color: var(--accent-dark);
      border-right: 1px solid var(--primary-medium);
    }

    th:first-child {
      text-align: left;
      max-width: 90px;
    }

    th:last-child {
      border-right: none;
    }

    td {
      padding: 0.5em;
      text-align: center;
      vertical-align: top;
      border-right: 1px solid var(--primary-medium);
      border-bottom: 1px solid #f0f0f0;
    }

    td:first-child {
      text-align: left;
      max-width: 90px;
      font-weight: 500;
    }

    td:last-child {
      border-right: none;
    }

    /* PUZZLE RESULTS */
    .submitted {
      background: transparent !important;
      white-space: pre-wrap;
      padding: 0.25em 0.5em;
      line-height: 1.2;
      border-radius: 4px;
      font-family: monospace;
    }

    .winner {
      background-color: #d4ffd4 !important;
    }

    .tie {
      background-color: #fff9c4 !important;
    }

    .dnf-cell {
      background-color: #ffebee !important;
      color: #c62828;
      font-weight: bold;
      font-style: italic;
      padding: 0.5em;
    }

    /* ACTION BUTTONS */
    .action-buttons {
      display: flex;
      gap: 0.5em;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.4em 0.8em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8em;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-edit {
      background: var(--purple-medium);
      color: var(--purple-dark);
    }

    .btn-submit {
      background: #10b981;
      color: white;
    }

    .btn-delete {
      background: #ef4444;
      color: white;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn.hidden {
      display: none;
    }

    /* PUZZLE LINKS */
    .puzzle-name {
      cursor: pointer;
      color: var(--purple-dark);
      text-decoration: underline;
      font-weight: 500;
    }

    .puzzle-name:hover {
      color: #553c9a;
    }

    .puzzle-nowrap {
      white-space: nowrap;
    }

    /* TEXTAREA */
    textarea {
      width: 100%;
      min-height: 60px;
      padding: 0.5em;
      border: 2px solid var(--purple-medium);
      border-radius: 6px;
      font-family: monospace;
      resize: vertical;
    }

    /* LOADING OVERLAY */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      color: #444;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* MOBILE OPTIMIZATIONS */
    @media (max-width: 768px) {
      .main-content {
        padding: 0.5em;
      }

      /* ENHANCED: Adjust for mobile edge-to-edge expansion */
      .top-strip.expanded {
        height: calc(100vh - 70px);
      }

      .bottom-strip.expanded {
        height: calc(100vh - 140px);
      }

      .main-content.top-expanded {
        margin-top: calc(100vh - 70px);
      }

      .main-content.bottom-expanded {
        margin-bottom: calc(100vh - 140px);
      }

      table {
        font-size: 0.85em;
      }

      .scoreboard-mini {
        font-size: 1.1em;
        padding: 0.75em;
      }

      .scoreboard-value {
        font-size: 1.6em;
      }

      .puzzle-date {
        font-size: 0.8em;
        margin: 0.25em 0 1em 0;
      }

      .history-expanded {
        padding: 1em 0.5em;
      }

      .chat-expanded {
  padding: 0.5em;
  height: calc(100vh - 280px); /* Consistent with desktop */
}

      .message-bubble {
        max-width: 85%;
      }
    }

    /* PULL TO REFRESH */
    .refresh-indicator {
      text-align: center;
      padding: 1em;
      color: var(--purple-dark);
      font-weight: 500;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

    .refresh-indicator.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* VERSION */
    .version {
      text-align: right;
      font-size: 0.8em;
      color: #888;
      margin-top: 2em;
      padding: 1em 0;
    }
    /* Add this new rule to fix Safari viewport issues */
@supports (-webkit-touch-callout: none) {
  /* Safari only - removed height rules since we're using clip-path */
}

/* Ensure chat-mini is always at the bottom of the strip when collapsed */
.chat-mini {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Position chat-expanded to fill the entire strip */
.chat-expanded {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  padding-top: 70px; /* Space for the header */
}

  </style>
</head>
<body>
  <div id="loadingOverlay">Loading‚Ä¶</div>

  <!-- Overlay for tap-to-dismiss -->
  <div class="overlay" id="overlay"></div>

  <!-- ENHANCED: Top Strip with edge-to-edge expansion -->
  <div class="top-strip" id="topStrip">
    <div class="swipe-indicator" id="topSwipeIndicator"></div>
    
    <div class="scoreboard-container">
      <!-- Mini Scoreboard (Always Visible) -->
      <div class="scoreboard-mini" id="scoreboardMini">
        <div class="scoreboard-item">
          <div class="scoreboard-label">ACB üåµ</div>
          <div id="acbCrown" class="crown" style="display: none;">üëë</div>
          <div id="acbCount" class="scoreboard-value">0</div>
        </div>
        <div class="scoreboard-item">
          <div class="scoreboard-label">JBB üí©</div>
          <div id="jbbCrown" class="crown" style="display: none;">üëë</div>
          <div id="jbbCount" class="scoreboard-value">0</div>
        </div>
        <div class="scoreboard-item">
          <div class="scoreboard-label">Cat üê±</div>
          <div id="tieCount" class="scoreboard-value">0</div>
        </div>
        <div class="scoreboard-item">
          <div class="scoreboard-label">Left ‚è≥</div>
          <div id="remainingCount" class="scoreboard-value">10</div>
        </div>
      </div>

      <!-- Expanded History & Stats (Shown on Swipe Down) -->
      <div class="history-expanded" id="historyExpanded">
        <div class="history-title">üìä History & Stats</div>
        
        <!-- Current Champ Panel -->
        <div class="current-champ-panel">
          <div class="current-champ-title">üèÜ Current Champion</div>
          <div class="champ-info">
            <div class="champ-name" id="currentChampName">No champion yet</div>
            <div class="champ-streak" id="currentChampStreak">Start competing!</div>
          </div>
        </div>
        
        <!-- Date Picker -->
        <div class="date-picker-container">
          <button class="date-nav-btn" id="prevDateBtn">‚óÄ Prev</button>
          <input type="date" class="date-picker" id="datePicker">
          <button class="date-nav-btn" id="nextDateBtn">Next ‚ñ∂</button>
          <button class="date-nav-btn" id="todayBtn">Today</button>
        </div>

        <!-- Streak Data Table -->
        <table class="history-table">
          <thead>
            <tr>
              <th>Puzzle</th>
              <th>Current Streak</th>
              <th>Record Streak</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <tr>
              <td>Loading...</td>
              <td>--</td>
              <td>--</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- FIXED: Main Content Area with proper margin management -->
  <div class="main-content both-collapsed" id="mainContent">
    <div class="refresh-indicator" id="refreshIndicator">
      ‚Üì Release to refresh ‚Üì
    </div>

    <h1>üß† I'm Puzzled ‚ÄºÔ∏è</h1>
    <div class="subtitle">If you ain't first, you're last</div>

    <div class="user-select-area">
      <label for="userSelect">Signed in as:
        <select id="userSelect" class="user-select">
          <option value="">(choose)</option>
          <option value="Adam">Adam üåµ</option>
          <option value="Jonathan">Jonathan üí©</option>
        </select>
      </label>
    </div>

    <div class="puzzle-date" id="puzzleDate">2025-06-03 (Tue)</div>

    <table id="puzzleTable">
      <thead>
        <tr>
          <th>Puzzle</th>
          <th>Adam üåµ</th>
          <th>Jonathan üí©</th>
        </tr>
      </thead>
      <tbody id="puzzleRows">
        <tr data-puzzle="Connections">
          <td><span class="puzzle-name puzzle-nowrap" data-url="https://www.nytimes.com/games/connections">Connections</span></td>
          <td data-cell="Connections-Adam"></td>
          <td data-cell="Connections-Jonathan"></td>
        </tr>
        <tr data-puzzle="Strands">
          <td><span class="puzzle-name" data-url="https://www.nytimes.com/games/strands">Strands</span></td>
          <td data-cell="Strands-Adam"></td>
          <td data-cell="Strands-Jonathan"></td>
        </tr>
        <tr data-puzzle="On the Record">
          <td><span class="puzzle-name" data-url="https://www.washingtonpost.com/news-quiz/">On the Record</span></td>
          <td data-cell="On the Record-Adam"></td>
          <td data-cell="On the Record-Jonathan"></td>
        </tr>
        <tr data-puzzle="Keyword">
          <td><span class="puzzle-name" data-url="https://washingtonpost.com/games/keyword/">Keyword</span></td>
          <td data-cell="Keyword-Adam"></td>
          <td data-cell="Keyword-Jonathan"></td>
        </tr>
        <tr data-puzzle="NYT Mini">
          <td><span class="puzzle-name" data-url="https://nytimes.com/crosswords/game/mini/">NYT Mini</span></td>
          <td data-cell="NYT Mini-Adam"></td>
          <td data-cell="NYT Mini-Jonathan"></td>
        </tr>
        <tr data-puzzle="Apple Mini">
          <td><span class="puzzle-name" data-url="https://apple.news/puzzles">Apple Mini</span></td>
          <td data-cell="Apple Mini-Adam"></td>
          <td data-cell="Apple Mini-Jonathan"></td>
        </tr>
        <tr data-puzzle="Globle">
          <td><span class="puzzle-name" data-url="https://globle-game.com">Globle</span></td>
          <td data-cell="Globle-Adam"></td>
          <td data-cell="Globle-Jonathan"></td>
        </tr>
        <tr data-puzzle="Flagle">
          <td><span class="puzzle-name puzzle-nowrap" data-url="https://www.flagle.io">Flagle</span></td>
          <td data-cell="Flagle-Adam"></td>
<td data-cell="Flagle-Jonathan"></td>
        </tr>
        <tr data-puzzle="Wordle">
          <td><span class="puzzle-name puzzle-nowrap" data-url="https://www.nytimes.com/games/wordle/index.html">Wordle</span></td>
          <td data-cell="Wordle-Adam"></td>
          <td data-cell="Wordle-Jonathan"></td>
        </tr>
        <tr data-puzzle="Tightrope">
          <td><span class="puzzle-name" data-url="https://www.britannica.com/quiz/tightrope">Tightrope</span></td>
          <td data-cell="Tightrope-Adam"></td>
          <td data-cell="Tightrope-Jonathan"></td>
        </tr>
      </tbody>
    </table>

    <div class="version">v2025.06.03.1 - UI Bug Fixes + Edge-to-Edge Expansion! ‚úÖ</div>
  </div>

  <!-- ENHANCED: Bottom Strip with edge-to-edge expansion -->
  <div class="bottom-strip" id="bottomStrip">
    <div class="swipe-indicator" id="bottomSwipeIndicator"></div>
    
    <div class="chat-container">
      <!-- Mini Chat Status (Always Visible) -->
      <div class="chat-mini" id="chatMini"> 
        <div class="swipe-indicator"></div>  <!-- ADD THIS LINE ONLY -->
        <div class="chat-status" id="chatStatus">üóëÔ∏è Talkin' Trash üî•</div>
        <div id="unreadBadge">0</div>
      </div>

      <!-- ENHANCED: Chat expanded with proper content rendering -->
    <div class="chat-expanded" id="chatExpanded">
      <!-- ADD THIS HEADER SECTION -->
      <div class="chat-expanded-header">
        <div class="swipe-indicator"></div>
        <div class="chat-header-text">üóëÔ∏è Talkin' Trash üî•</div>
      </div>
      <!-- END OF ADDED SECTION -->
      
      <div class="chat-messages" id="chatMessages">
        <div style="text-align: center; color: #666; font-style: italic; padding: 2em;">
          Select a user to start trash talking! üî•
        </div>
      </div>
        
        <div class="chat-input-container">
          <textarea class="chat-input" id="chatInput" placeholder="Type your trash talk..." rows="2" disabled></textarea>
          <button class="chat-send-btn" id="chatSendBtn" disabled>üöÆ</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    console.log('üß† I\'m Puzzled ‚ÄºÔ∏è v2025.06.03.1 - UI Bug Fixes + Edge-to-Edge Expansion');
    
    // Global state variables - declared at top level for Safari compatibility
    let currentPuzzleDate = null;
    let topStripExpanded = false;
    let bottomStripExpanded = false;
    let pullStartY = 0;
    let isPulling = false;

    // Utility functions - moved to top level for proper scope
    function getCurrentDate() {
      return new Date().toISOString().slice(0, 10);
    }

    function formatDateDisplay(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const dayName = days[date.getDay()];
      return `${dateStr} (${dayName})`;
    }

    function updatePuzzleDateDisplay(dateStr = null) {
      const displayDate = dateStr || getCurrentDate();
      currentPuzzleDate = displayDate;
      document.getElementById('puzzleDate').textContent = formatDateDisplay(displayDate);
      
      const datePicker = document.getElementById('datePicker');
      if (datePicker) {
        datePicker.value = displayDate;
      }
    }

    // Overlay management functions - moved to top level
    function showOverlay() {
      const overlay = document.getElementById('overlay');
      overlay.classList.add('visible');
    }

    function hideOverlay() {
      const overlay = document.getElementById('overlay');
      overlay.classList.remove('visible');
    }

    // ENHANCED: Strip expansion functions with edge-to-edge and main content management
    function executeTopStripOpen() {
      const topStrip = document.getElementById('topStrip');
      const mainContent = document.getElementById('mainContent');
      
      topStrip.classList.add('expanded');
      mainContent.classList.remove('both-collapsed', 'bottom-expanded');
      mainContent.classList.add('top-expanded');
      
      topStripExpanded = true;
      showOverlay();
      loadHistoryData();
      updateCurrentChampDisplay();
      
      if (window.updateTapZones) window.updateTapZones();
      console.log('üìä Top strip expanded - edge-to-edge to bottom strip');
    }

    function executeTopStripClose() {
      const topStrip = document.getElementById('topStrip');
      const mainContent = document.getElementById('mainContent');
      
      topStrip.classList.remove('expanded');
      mainContent.classList.remove('top-expanded');
      if (bottomStripExpanded) {
        mainContent.classList.add('bottom-expanded');
      } else {
        mainContent.classList.add('both-collapsed');
      }
      
      topStripExpanded = false;
      hideOverlay();
      
      if (window.updateTapZones) window.updateTapZones();
      console.log('üìä Top strip collapsed');
    }

    function executeBottomStripOpen() {
      const bottomStrip = document.getElementById('bottomStrip');
      const mainContent = document.getElementById('mainContent');
      
      bottomStrip.classList.add('expanded');
    
      mainContent.classList.remove('both-collapsed', 'top-expanded');
      mainContent.classList.add('bottom-expanded');
      
      bottomStripExpanded = true;
      showOverlay();
      
      // ENHANCED: Delay chat system call to let CSS animation work
      if (window.chatSystem) {
        setTimeout(() => {
          window.chatSystem.showChat();
        }, 50); // Small delay to let container animation start
      } else {
        loadChatMessages(); // Fallback
      }
      
      if (window.updateTapZones) window.updateTapZones();
      console.log('üí¨ Bottom strip expanded - edge-to-edge to top strip');
    }

    function executeBottomStripClose() {
      const bottomStrip = document.getElementById('bottomStrip');
      const mainContent = document.getElementById('mainContent');
      
      bottomStrip.classList.remove('expanded');
      mainContent.classList.remove('bottom-expanded');
      if (topStripExpanded) {
        mainContent.classList.add('top-expanded');
      } else {
        mainContent.classList.add('both-collapsed');
      }
      
      bottomStripExpanded = false;
      hideOverlay();
      
      if (window.updateTapZones) window.updateTapZones();
      console.log('üí¨ Bottom strip collapsed');
    }

    // Toggle functions for strips - fixed scope issues
    function toggleTopStrip() {
      if (bottomStripExpanded && !topStripExpanded) {
        executeBottomStripClose();
        return;
      }
      
      if (topStripExpanded) {
        executeTopStripClose();
        return;
      }
      
      executeTopStripOpen();
    }

    function toggleBottomStrip() {
      if (topStripExpanded && !bottomStripExpanded) {
        executeTopStripClose();
        return;
      }
      
      if (bottomStripExpanded) {
        executeBottomStripClose();
        return;
      }
      
      executeBottomStripOpen();
    }

    // Gesture and tap zone initialization
    function initializeGestures() {
      const overlay = document.getElementById('overlay');
      const topIndicator = document.getElementById('topSwipeIndicator');
      const bottomIndicator = document.getElementById('bottomSwipeIndicator');

      // Create tap zones that HIDE when strips expand
      const topTapZone = document.createElement('div');
      topTapZone.id = 'topTapZone';
      topTapZone.style.cssText = `
        position: fixed;
        top: 120px;
        left: 0;
        right: 0;
        height: 40px;
        z-index: 1002;
        cursor: pointer;
        background: transparent;
        pointer-events: auto;
      `;
      
      const bottomTapZone = document.createElement('div');
      bottomTapZone.id = 'bottomTapZone';
      bottomTapZone.style.cssText = `
        position: fixed;
        bottom: 40px;
        left: 0;
        right: 0;
        height: 40px;
        z-index: 1002;
        cursor: pointer;
        background: transparent;
        pointer-events: auto;
      `;

      document.body.appendChild(topTapZone);
      document.body.appendChild(bottomTapZone);

      // Event handlers
      function handleTopTap(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleTopStrip();
      }

      function handleBottomTap(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleBottomStrip();
      }

      // Attach event listeners
      topTapZone.addEventListener('click', handleTopTap);
      topTapZone.addEventListener('touchend', handleTopTap);
      bottomTapZone.addEventListener('click', handleBottomTap);
      bottomTapZone.addEventListener('touchend', handleBottomTap);

      // Purple indicator events
      if (topIndicator) {
        topIndicator.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleTopStrip();
        });
      }

      if (bottomIndicator) {
        bottomIndicator.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleBottomStrip();
        });
      }

      // Overlay for closing expanded strips
      if (overlay) {
        overlay.addEventListener('click', () => {
          if (topStripExpanded) toggleTopStrip();
          if (bottomStripExpanded) toggleBottomStrip();
        });
      }
      
      // CRITICAL FIX: Hide/show tap zones based on strip state
      window.updateTapZones = function() {
        if (topStripExpanded) {
          topTapZone.style.display = 'none';
        } else {
          topTapZone.style.display = 'block';
        }
        
        if (bottomStripExpanded) {
          bottomTapZone.style.display = 'none';
        } else {
          bottomTapZone.style.display = 'block';
        }
      };
    }
      
    // Add this function after initializeGestures()
    function setupCrossStripCollapse() {
      const topStrip = document.getElementById('topStrip');
      const bottomStrip = document.getElementById('bottomStrip');
      
      // Create a tap handler for the top strip
      const handleTopStripTap = (e) => {
        // Only work if bottom strip (chat) is expanded
        if (window.bottomStripExpanded) {
          // CRITICAL: Exclude clicks on expanded history
          if (e.target.closest('.history-expanded')) {
            return; // Don't collapse if clicking in history
          }
          
          // Check if the tap is on the strip header area only
          if (e.target.closest('.scoreboard-mini') || 
              e.target.closest('.swipe-indicator') ||
              (e.target.closest('.scoreboard-container') && !e.target.closest('.history-expanded'))) {
            e.preventDefault();
            e.stopPropagation();
            // Collapse the chat
            window.toggleBottomStrip();
          }
        }
      };
      
      // Add event listeners to top strip
      topStrip.addEventListener('click', handleTopStripTap);
      topStrip.addEventListener('touchend', handleTopStripTap);
      
      // Similarly for bottom strip when top is expanded
      const handleBottomStripTap = (e) => {
        if (window.topStripExpanded) {
          // CRITICAL FIX: Exclude clicks on the expanded chat area
          if (e.target.closest('.chat-expanded') || 
              e.target.closest('.chat-input-container') ||
              e.target.closest('.chat-messages') ||
              e.target.closest('#chatInput') ||
              e.target.closest('#chatSendBtn')) {
            return; // Don't collapse if clicking in chat area
          }
          
          // Only collapse if clicking the mini chat status or swipe indicator
          if (e.target.closest('.chat-mini') || 
              e.target.closest('.swipe-indicator')) {
            e.preventDefault();
            e.stopPropagation();
            window.toggleTopStrip();
          }
        }
      };
      
      bottomStrip.addEventListener('click', handleBottomStripTap);
      bottomStrip.addEventListener('touchend', handleBottomStripTap);
    }
    
    // ENHANCED: Global strip state tracking for other modules
    window.topStripExpanded = false;
    window.bottomStripExpanded = false;

    // Update global state when strips change
    const originalToggleTopStrip = toggleTopStrip;
    const originalToggleBottomStrip = toggleBottomStrip;

    window.toggleTopStrip = function() {
      originalToggleTopStrip();
      window.topStripExpanded = topStripExpanded;
    };

    window.toggleBottomStrip = function() {
      originalToggleBottomStrip();
      window.bottomStripExpanded = bottomStripExpanded;
    };

    // Scoreboard update function
    window.enhancedUpdateScoreboard = function(acb, jbb, tie, remaining) {
      document.getElementById("acbCount").textContent = acb;
      document.getElementById("jbbCount").textContent = jbb;
      document.getElementById("tieCount").textContent = tie;
      document.getElementById("remainingCount").textContent = remaining;

      const acbEl = document.getElementById("acbCount");
      const jbbEl = document.getElementById("jbbCount");
      const acbCrown = document.getElementById("acbCrown");
      const jbbCrown = document.getElementById("jbbCrown");

      // Reset crowns
      acbCrown.style.display = "none";
      jbbCrown.style.display = "none";

      const canAcbWin = acb + remaining > jbb;
      const canJbbWin = jbb + remaining > acb;

      if (acb > jbb && !canJbbWin) {
        acbEl.style.color = "#10b981";
        jbbEl.style.color = "#ef4444";
        acbCrown.style.display = "block";
      } else if (jbb > acb && !canAcbWin) {
        jbbEl.style.color = "#10b981";
        acbEl.style.color = "#ef4444";
        jbbCrown.style.display = "block";
      } else if (acb > jbb) {
        acbEl.style.color = "#10b981";
        jbbEl.style.color = "#ef4444";
      } else if (jbb > acb) {
        jbbEl.style.color = "#10b981";
        acbEl.style.color = "#ef4444";
      } else {
        acbEl.style.color = "#f59e0b";
        jbbEl.style.color = "#f59e0b";
      }

      updateCurrentChampDisplay();
    };

    function updateCurrentChampDisplay() {
      const champName = document.getElementById('currentChampName');
      const champStreak = document.getElementById('currentChampStreak');
      
      if (window.scoreboard && window.scoreboard.getCurrentChampion) {
        const champ = window.scoreboard.getCurrentChampion();
        if (champ) {
          const emoji = champ.name === 'Adam' ? ' üåµ' : ' üí©';
          champName.textContent = champ.name + emoji;
          champStreak.textContent = `${champ.streak} day${champ.streak !== 1 ? 's' : ''} streak`;
        }
      }
    }

    function updateUIVisibility() {
      const userSelect = document.getElementById('userSelect');
      const currentUser = userSelect.value;
      const unreadBadge = document.getElementById('unreadBadge');
      
      const actionButtons = document.querySelectorAll('.btn-edit, .btn-submit');
      actionButtons.forEach(btn => {
        if (currentUser) {
          btn.classList.remove('hidden');
        } else {
          btn.classList.add('hidden');
        }
      });

      if (!currentUser) {
        unreadBadge.style.display = 'none';
      }
    }

    function initializeDatePicker() {
      const datePicker = document.getElementById('datePicker');
      const prevBtn = document.getElementById('prevDateBtn');
      const nextBtn = document.getElementById('nextDateBtn');
      const todayBtn = document.getElementById('todayBtn');

      datePicker.addEventListener('change', (e) => {
        const selectedDate = e.target.value;
        updatePuzzleDateDisplay(selectedDate);
        loadPuzzleDataForDate(selectedDate);
      });

      prevBtn.addEventListener('click', () => {
        const currentDate = new Date(currentPuzzleDate);
        currentDate.setDate(currentDate.getDate() - 1);
        const newDate = currentDate.toISOString().slice(0, 10);
        updatePuzzleDateDisplay(newDate);
        loadPuzzleDataForDate(newDate);
      });

      nextBtn.addEventListener('click', () => {
        const currentDate = new Date(currentPuzzleDate);
        currentDate.setDate(currentDate.getDate() + 1);
        const newDate = currentDate.toISOString().slice(0, 10);
        updatePuzzleDateDisplay(newDate);
        loadPuzzleDataForDate(newDate);
      });

      todayBtn.addEventListener('click', () => {
        const today = getCurrentDate();
        updatePuzzleDateDisplay(today);
        loadPuzzleDataForDate(today);
      });
    }

    function loadHistoryData() {
      const historyTableBody = document.getElementById('historyTableBody');
      
      historyTableBody.innerHTML = `
        <tr><td colspan="3" style="text-align: center; padding: 2em;">Loading history data...</td></tr>
      `;

      setTimeout(() => {
        updateHistoryTable();
      }, 500);
    }

    function updateHistoryTable() {
      const historyTableBody = document.getElementById('historyTableBody');
      const puzzles = [
        'Connections', 'Strands', 'On the Record', 'Keyword', 'NYT Mini',
        'Apple Mini', 'Globle', 'Flagle', 'Wordle', 'Tightrope'
      ];

      historyTableBody.innerHTML = '';
      
      puzzles.forEach(puzzle => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="font-weight: 600;">${puzzle}</td>
          <td class="streak-current">--</td>
          <td class="streak-record">--</td>
        `;
        historyTableBody.appendChild(row);
      });
    }

    // FIXED: Delegate to real chat system
    function loadChatMessages() {
      if (window.chatSystem && window.chatSystem.loadMessages) {
        console.log('üí¨ Using real chat system');
        window.chatSystem.loadMessages();
      } else {
        console.log('‚è≥ Chat system not ready yet');
      }
    }

    // Move sendChatMessage to global scope
    window.sendChatMessage = async function() {
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      const userSelect = document.getElementById('userSelect');
      
      if (!chatInput || !chatSendBtn || !userSelect) return;
      
      const message = chatInput.value.trim();
      if (!message) return;

      // Prevent duplicate processing
      if (window.isSendingMessage) return;
      window.isSendingMessage = true;
      
      // Store original button text
      const originalBtnText = chatSendBtn.textContent;
      chatSendBtn.disabled = true;
      chatSendBtn.textContent = '‚è≥';

      try {
        // Clear input immediately
        chatInput.value = '';
        
        // Send to database WITHOUT adding a temporary message
        console.log('üí¨ Send message:', message);
        
        // Call the actual supabase send function
        const today = new Date().toISOString().slice(0, 10);
        await window.supabaseClient.sendChatMessage(today, userSelect.value, message);
        
        // The real-time subscription will handle adding the message to the display
        
      } catch (error) {
        console.error('Failed to send message:', error);
        alert('Failed to send message. Please try again.');
        // Restore the message on error
        chatInput.value = message;
      } finally {
        window.isSendingMessage = false;
        
        // Get fresh reference to button
        const btn = document.getElementById('chatSendBtn');
        if (btn) {
          btn.textContent = originalBtnText;
          
          // Force remove focus and active states
          btn.blur();
          
          // Remove all inline styles
          btn.style.opacity = '';
          btn.style.transform = '';
          btn.style.boxShadow = '';
          btn.style.background = '';
          
          // Force repaint
          btn.offsetHeight;
          
          // Update disabled state
          setTimeout(() => {
            const hasText = chatInput.value.trim().length > 0;
            const hasUser = !!userSelect.value;
            btn.disabled = !hasText || !hasUser;
            
            // Focus back on input
            chatInput.focus();
          }, 50);
        }
      }
    };

    function initializeChatSystem() {
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      const userSelect = document.getElementById('userSelect');

      userSelect.addEventListener('change', (e) => {
        const hasUser = !!e.target.value;
        chatInput.disabled = !hasUser;
        chatSendBtn.disabled = !hasUser;
        
        if (hasUser) {
          document.getElementById('chatStatus').textContent = 'Ready to trash talk! üî•';
        } else {
          document.getElementById('chatStatus').textContent = 'Select user to enable chat';
        }

        updateUIVisibility();
      });
      
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && !window.isSendingMessage) {
          e.preventDefault();
          window.sendChatMessage();
        }
      });

      chatInput.addEventListener('input', () => {
        const hasText = chatInput.value.trim().length > 0;
        const hasUser = !!userSelect.value;
        chatSendBtn.disabled = !hasText || !hasUser || window.isSendingMessage;
      });
      
      // Initial setup for send button
      setupSendButton();
    }

    // Separate function to set up the send button
    window.setupSendButton = function() {
      const chatSendBtn = document.getElementById('chatSendBtn');
      
      if (!chatSendBtn) return;
      
      // Remove ALL existing listeners by cloning
      const newBtn = chatSendBtn.cloneNode(true);
      chatSendBtn.parentNode.replaceChild(newBtn, chatSendBtn);
      
      // Add click handler
      newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        window.sendChatMessage();
      });
      
      // Prevent touch highlighting
      newBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
      
      newBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        e.stopPropagation();
        window.sendChatMessage();
      });
      
      console.log('‚úÖ Send button setup complete');
    };

    // Re-setup send button after modules load
    setTimeout(() => {
      window.setupSendButton();
    }, 1000);

    function loadPuzzleDataForDate(date) {
      console.log('üìä Loading puzzle data for:', date);
      if (window.appInstance && window.appInstance.loadDataForDate) {
        window.appInstance.loadDataForDate(date);
      }
    }

    // Global exports for compatibility
    window.createDNFCell = function() {
      const div = document.createElement('div');
      div.className = 'dnf-cell';
      div.textContent = 'DNF';
      return div;
    };

    window.DEADLINE_CONFIG = {
      'Connections': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15 },
      'Strands': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15 },
      'On the Record': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15, weekendExtended: true },
      'Keyword': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15 },
      'NYT Mini': { resetTime: '22:00', timezone: 'ET', gracePeriod: 15, weekendTime: '18:00' },
      'Apple Mini': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15 },
      'Globle': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15 },
      'Flagle': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15 },
      'Wordle': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15 },
      'Tightrope': { resetTime: '00:00', timezone: 'ET', gracePeriod: 15 }
    };

    // Call this function in your initialize() function
    function initializeUI() {
      updatePuzzleDateDisplay();
      initializeGestures();
      setupCrossStripCollapse();
      initializeDatePicker();
      initializeChatSystem();
      updateUIVisibility();
      
      console.log('‚úÖ ENHANCED UI initialized - Edge-to-edge expansion + Bug fixes v2025.06.03.1');
    }
 
    // Initialize everything
    function initialize() {
      initializeUI();
    }

    // Start the app
    initialize();
    
    // ENHANCED: Your complete modular system loading with UI fixes
    import('./modules/core/supabase-client.js').then(async (supabaseModule) => {
      console.log('‚úÖ Supabase module loaded');
      
      const supabaseClient = supabaseModule.default;
      window.supabase = supabaseClient.getClient();
      window.supabaseClient = supabaseClient;
      
      const isHealthy = await supabaseClient.testConnection();
      if (!isHealthy) {
        console.error('‚ùå Database connection failed');
        document.getElementById('loadingOverlay').style.display = 'none';
        return;
      }
      
      const { default: app } = await import('./modules/app/main.js');
      
      app.updatePuzzleDateDisplay = updatePuzzleDateDisplay;
      app.enhancedUpdateScoreboard = window.enhancedUpdateScoreboard;
      app.createDNFCell = window.createDNFCell;
      app.DEADLINE_CONFIG = window.DEADLINE_CONFIG;
      
      app.startNewDay = function() {
        console.log('üÜï Starting new puzzle day...');
        const newDate = getCurrentDate();
        updatePuzzleDateDisplay(newDate);
        
        if (app.resetForNewDay) {
          app.resetForNewDay();
        }
      };
      
      await app.init();
      window.appInstance = app;
      
      console.log('üéâ Complete modular system loaded with UI fixes v2025.06.03.1!');
      
    }).catch(error => {
      console.error('üí• Module loading failed:', error);
      document.getElementById('loadingOverlay').style.display = 'none';
      
      document.body.innerHTML += `
        <div style="text-align: center; padding: 2em; color: #666; background: #f5f5f5; border-radius: 8px; margin: 2em;">
          <h2>‚ö†Ô∏è Module Loading Failed</h2>
          <p>The modular framework could not load. Please ensure all module files are present.</p>
        </div>
      `;
    });

  </script>
</body>
</html> 